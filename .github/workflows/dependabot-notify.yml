name: Dependabot Notifications

on:
  # NOTE: dependabot PRs do not receive repository secrets in `pull_request` workflows.
  # Use `pull_request_target` so we can send notifications safely (this workflow does not checkout PR code).
  pull_request_target:
    types: [opened, closed, reopened]

permissions:
  contents: read

jobs:
  notify-dependabot:
    name: Notify Dependabot PR
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: Send Telegram Notification (Opened/Reopened)
        if: github.event.action == 'opened' || github.event.action == 'reopened'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_TO_GROUP: ${{ secrets.TELEGRAM_TO_GROUP }}
          TELEGRAM_DEPENDABOT_TOPIC_ID: ${{ secrets.TELEGRAM_DEPENDABOT_TOPIC_ID }}
          MESSAGE: |
            ðŸ“¦ Dependabot Update
            
            Repo: ${{ github.repository }}
            PR: #${{ github.event.number }} ${{ github.event.pull_request.title }}
            
            Link: ${{ github.event.pull_request.html_url }}
        run: |
          if [ -z "${TELEGRAM_TOKEN}" ] || [ -z "${TELEGRAM_TO_GROUP}" ]; then
            echo "Telegram secrets are not configured. Skipping notification."
            exit 0
          fi

          args=(
            -fSs -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage"
            -d "chat_id=${TELEGRAM_TO_GROUP}"
            --data-urlencode "text=$MESSAGE"
          )
          if [ -n "${TELEGRAM_DEPENDABOT_TOPIC_ID}" ]; then
            args+=(-d "message_thread_id=${TELEGRAM_DEPENDABOT_TOPIC_ID}")
          fi
          curl "${args[@]}"

      - name: Send Telegram Notification (Merged)
        if: github.event.action == 'closed' && github.event.pull_request.merged == true
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_TO_GROUP: ${{ secrets.TELEGRAM_TO_GROUP }}
          TELEGRAM_DEPENDABOT_TOPIC_ID: ${{ secrets.TELEGRAM_DEPENDABOT_TOPIC_ID }}
          MESSAGE: |
            âœ… Dependabot PR Merged
            
            Repo: ${{ github.repository }}
            PR: #${{ github.event.number }} ${{ github.event.pull_request.title }}
        run: |
          if [ -z "${TELEGRAM_TOKEN}" ] || [ -z "${TELEGRAM_TO_GROUP}" ]; then
            echo "Telegram secrets are not configured. Skipping notification."
            exit 0
          fi

          args=(
            -fSs -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage"
            -d "chat_id=${TELEGRAM_TO_GROUP}"
            --data-urlencode "text=$MESSAGE"
          )
          if [ -n "${TELEGRAM_DEPENDABOT_TOPIC_ID}" ]; then
            args+=(-d "message_thread_id=${TELEGRAM_DEPENDABOT_TOPIC_ID}")
          fi
          curl "${args[@]}"
